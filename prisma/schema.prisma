generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model CashPosition {
  id           String   @id
  name         String
  balance      Float
  interestRate Float
  isLiquid     Boolean
  category     String   // cash, savings, isa, crypto
  provider     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([createdAt])
}

model IncomeStream {
  id               String   @id
  name             String
  amount           Float
  frequency        String   // monthly, quarterly, annual
  paymentMonths    Int[]    // which months (1-12)
  owner            String   // lawrence, stephanie, joint
  taxable          Boolean
  provider         String?
  monthlyOverrides String?  // JSON: Record<string, number> keyed by YYYY-MM
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([createdAt])
}

model Expense {
  id               String   @id
  name             String
  provider         String?
  amount           Float
  frequency        String   // monthly, quarterly, termly, annual, bimonthly, one-off
  category         String   // debt, school, holiday, groceries, etc.
  activeMonths     Int[]    // 1-12, if only active certain months
  paymentMonths    Int[]    // specific months for quarterly/annual/bimonthly
  startDate        String?  // YYYY-MM
  endDate          String?  // YYYY-MM
  notes            String?
  monthlyOverrides String?  // JSON: Record<string, number> keyed by YYYY-MM
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([createdAt])
}

model Asset {
  id               String   @id
  name             String
  currentValue     Float
  annualGrowthRate Float
  category         String   // savings, isa, crypto, fund, angel, pension, property, vehicle, children_isa
  isLiquid         Boolean
  unlockYear       Int?
  endYear          Int?
  notes            String?
  provider         String?
  costBasis        Float?
  costCurrency     String?  // GBP, USD, EUR, CHF
  costBasisGBP     Float?   // cost basis converted to GBP at historical XE rate
  fxRate           Float?   // historical XE rate used (foreign currency to GBP)
  instrument       String?  // safe, equity, options, advance_subscription
  investmentDate   String?  // ISO date
  exitDate         String?  // ISO date
  exitMethod       String?  // write_off, secondary, acquisition, ipo
  status           String?  // active, exited, written_off
  taxScheme        String?  // SEIS, EIS
  platform         String?  // odin, direct, feedforward, vauban, seedlegals
  geography        String?  // UK, US, Switzerland, etc.
  industry         String?  // sector/industry description
  ownershipPercent Float?   // ownership % as decimal (e.g. 0.005 = 0.5%)
  irr              Float?   // gross IRR as decimal (e.g. 0.2863 = 28.63%)
  emailUpdates     String?  // JSON array of {subject, from, date, snippet}
  registration     String?  // vehicle registration number (e.g. GY17STZ)
  mileage          Int?     // current odometer reading
  vehicleData      String?  // JSON: DVLA + valuation data
  purchasePrice    Float?   // original purchase price (property)
  purchaseDate     String?  // purchase date YYYY-MM (property)
  propertyAddress  String?  // full address (property)
  propertyRegion   String?  // Land Registry UKHPI region slug (property)
  propertyData     String?  // JSON: UKHPI valuation data
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([createdAt])
}

model Liability {
  id             String   @id
  name           String
  currentBalance Float
  interestRate   Float
  monthlyPayment Float
  type           String   // mortgage, student_loan, credit_card, other
  endYear        Int?
  provider       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([createdAt])
}

model Transaction {
  id             String   @id
  date           String   // ISO date string
  description    String
  amount         Float    // negative = debit, positive = credit
  category       String?
  source         String   // monzo, manual
  linkedEntityId String?
  emailId        String?  @unique // for deduplication on reimport
  createdAt      DateTime @default(now())

  @@index([date])
  @@index([source])
}

model CarryPosition {
  id                   String             @id
  fundName             String
  provider             String
  fundSize             Float
  committedCapital     Float
  carryPercent         Float
  hurdleRate           Float
  personalSharePercent Float
  linkedAssetId        String?
  location             String?
  fundCloseYear        Int?
  notes                String?
  portfolioCompanies   PortfolioCompany[]
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  @@index([createdAt])
}

model PortfolioCompany {
  id               String        @id
  name             String
  legalEntity      String?
  investedAmount   Float
  currentValuation Float
  ownershipPercent Float
  status           String        // active, exited, written_off, marked_up
  investmentDate   String?       // MMM-YY e.g. "Apr-20"
  exitDate         String?       // MMM-YY e.g. "Jun-25"
  holdingPeriod    Float?        // years
  exitMethod       String?       // secondary, write_off, ipo, acquisition
  geography        String?
  industry         String?
  proceeds         Float?        // cash proceeds/repayments
  cashIncome       Float?        // dividends/interest received
  irr              Float?        // gross IRR as decimal (e.g. 0.2863 = 28.63%)
  notes            String?
  displayOrder     Int           @default(0)
  carryPositionId  String
  carryPosition    CarryPosition @relation(fields: [carryPositionId], references: [id], onDelete: Cascade)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
}

model Scenario {
  id          String   @id
  name        String
  description String
  overrides   String   // JSON string for complex nested structure
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([createdAt])
}

model Settings {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
}

model MonzoToken {
  id           Int      @id @default(1)
  accessToken  String
  refreshToken String
  expiresAt    DateTime
  accountId    String
  userId       String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}
